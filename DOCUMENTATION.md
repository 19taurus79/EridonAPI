# Документация по проекту Agri-Bot Backend

Этот документ описывает архитектуру и ключевые компоненты бэкенд-сервиса для проекта Agri-Bot.

## 1. Архитектура и поток данных

Проект представляет собой асинхронное веб-приложение на **FastAPI**, предназначенное для обработки и анализа данных, поступающих из Excel-файлов. Основная база данных — **PostgreSQL**, для взаимодействия с которой используется **Piccolo ORM**. Уведомления пользователям отправляются через **Telegram Bot**.

### Диаграмма потока данных (Data Flow Diagram)

```mermaid
graph TD
    subgraph "Пользователь"
        A[Excel-файлы]
    end

    subgraph "Backend-сервис (FastAPI)"
        B(main.py <br> /upload-data)
        C(data_loader.py <br> save_processed_data_to_db)
        D(data_processing.py <br> process_...())
        E(services/ordered_moved_notifications.py <br> notifications())
    end

    subgraph "Хранилище"
        F[PostgreSQL <br> (Piccolo ORM)]
    end
    
    subgraph "Внешние сервисы"
        G[Telegram Bot]
        H[Google Calendar]
    end

    A -- Загрузка --> B
    B -- Вызов в фоновом режиме --> C
    C -- 1. Чтение и очистка --> D
    D -- Возврат DataFrame --> C
    C -- 2. Сохранение в БД --> F
    C -- 3. Вызов уведомлений --> E
    E -- Получение данных о менеджерах --> F
    E -- Отправка сообщения --> G
    B -- Создание событий --> H
```

---

## 2. Описание модулей и эндпоинтов

### `main.py`
- **Назначение:** Главный файл, точка входа в приложение. Инициализирует FastAPI, настраивает CORS и подключает все основные маршруты (роутеры).
- **Ключевые эндпоинты:**
    - `POST /upload-data`:
        - **Назначение:** Основной эндпоинт для загрузки и полной обработки данных.
        - **Принимает:** Набор Excel-файлов (`av_stock_file`, `remains_file`, `submissions_file`, `payment_file`, `free_stock`) и опциональный JSON `manual_matches_json`.
        - **Логика:** Запускает в фоновом режиме (`BackgroundTasks`) основную задачу `save_processed_data_to_db` из `data_loader.py`. Сразу возвращает ответ `202 Accepted`.
    - `POST /delivery/send`:
        - **Назначение:** Оформление новой доставки.
        - **Принимает:** Тело запроса с моделью `DeliveryRequest`, содержащей полную информацию о доставке (клиент, адрес, товары, партии). Требует заголовок `X-Telegram-Init-Data` для аутентификации.
        - **Логика:** Формирует сообщение и Excel-отчет, создает событие в Google Calendar, сохраняет данные в таблицы `Deliveries` и `DeliveryItems` и рассылает уведомления.
    - `PUT /delivery/update`:
        - **Назначение:** Обновляет статус и состав существующей доставки.
        - **Принимает:** `UpdateDeliveryRequest` с `delivery_id` и новым списком товаров/статусом.
        - **Логика:** В рамках одной транзакции обновляет статус, удаляет старые товары (`DeliveryItems`) и вставляет новые. Отправляет уведомления об изменении статуса.
    - `POST /orders/comments/create` и другие (`/list`, `/{comment_id}`):
        - **Назначение:** CRUD-операции для создания, получения, обновления и удаления комментариев к заказам.
        - **Логика:** Позволяют управлять комментариями, привязанными к заказам, с проверкой прав доступа (только автор может редактировать/удалять).

### `data_retrieval.py` (префикс `/data`)
- **Назначение:** Модуль для предоставления доступа (чтения) к обработанным данным из БД.
- **Ключевые эндпоинты:**
    - `GET /remains`: Возвращает все записи об остатках на складе.
    - `GET /remains/{product_id}`: Возвращает остатки по конкретному ID продукта.
    - `GET /products`: Возвращает список продуктов из справочника с возможностью поиска по категории и части названия.
    - `GET /clients`: Возвращает список клиентов. Для администратора — всех, для менеджера — только его.
    - `GET /orders/{client}`: Возвращает все активные заказы (`different > 0`) для конкретного клиента.
    - `GET /contract_detail/{contract}`: Возвращает детальную информацию по всем позициям в рамках одного контракта (дополнения).
    - `GET /details_for_orders/{order}`: Возвращает сгруппированные данные по заказу, объединяя информацию о товарах и связанных с ними партиях.

### `bi.py` (префикс `/api/v2`)
- **Назначение:** Модуль для сложной бизнес-аналитики (Business Intelligence).
- **Ключевые эндпоинты:**
    - `GET /remains`: Возвращает остатки, сгруппированные по сериям номенклатуры, и общие итоги по каждому товару.
    - `GET /combined`:
        - **Назначение:** Самый сложный аналитический эндпоинт. Сравнивает общий спрос на товары с остатками и доступными запасами.
        - **Логика:** Делает несколько запросов к БД (`Submissions`, `Remains`, `FreeStock`), агрегирует данные и формирует два списка:
            1. `missing_but_available`: Товары, которых не хватает для покрытия спроса, но они есть на других складах.
            2. `missing_and_unavailable`: Товары, которых не хватает и их нет в свободных остатках.
        - **Возвращает:** Детальный JSON с полной информацией по дефицитным позициям, включая список заказов и доступные остатки по складам.

### `order_chat.py` (префикс `/orders/{order_ref}/chat`)
- **Назначение:** Реализует функциональность чата по конкретной заявке. Все эндпоинты требуют аутентификации.
- **Ключевые эндпоинты:**
    - `GET /messages`: Получает всю историю сообщений для указанного `order_ref`.
    - `POST /messages`: Создает новое сообщение в чате.
    - `PUT /messages/{message_id}`: Редактирует существующее сообщение (только автор).
    - `DELETE /messages/{message_id}`: Удаляет сообщение (автор или администратор).

---
### Другие важные файлы

- **`config.py`**: Хранит все конфигурационные данные (токены, ID, параметры БД), загружая их из `.env` файла.
- **`tables.py`**: Содержит ORM-модели Piccolo, описывающие схему базы данных.
- **`data_processing.py`**: Набор функций для предварительной очистки и трансформации данных из Excel в pandas DataFrame.
- **`data_loader.py`**: Оркестратор, который управляет всем процессом загрузки данных, вызывая `data_processing`, сохраняя данные в БД через `tables` и запуская уведомления.
- **`services/ordered_moved_notifications.py`**: Формирует и рассылает уведомления в Telegram о новых перемещениях товаров.
- **`telegram_auth.py`**: Реализует механизм аутентификации пользователей через `initData` Telegram Mini Apps.
